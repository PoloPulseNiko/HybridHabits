<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Entry | The Hybrid Habits</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header></header>

    <main>
        <section id="blog-entry" class="hero">
            <article class="blog-post" id="post-article">
                <h3 class="post-title" id="post-title">Loading...</h3>
                <p class="post-date" id="post-date"></p>
                <div id="post-content"></div>
                
                <!-- Comments Section -->
                <div id="comments-section" style="margin-top: 40px; display: none;">
                    <h3 style="margin-bottom: 20px; color: #333333; font-size: 1.3em; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #999999; padding-bottom: 10px;">Comments</h3>
                    <script src="https://utteranc.es/client.js"
                            repo="PoloPulseNiko/HybridHabits"
                            issue-term="title"
                            theme="github-light"
                            crossorigin="anonymous"
                            async>
                    </script>
                </div>
                
                <p id="post-back" style="margin-top: 30px; display: none;"><a href="blog.html">‚Üê Back to Blog</a></p>
                <p id="post-status" class="post-excerpt" style="margin-top: 20px; display: none;"></p>
            </article>
        </section>

        <aside class="sidebar">
            <div class="sidebar-box">
                <h3>Navigation</h3>
                <p><a href="index.html">Home</a></p>
                <p><a href="blog.html">All Blog Posts</a></p>
            </div>
        </aside>
    </main>

    <footer></footer>
    <script src="load-components.js"></script>
    <script src="music-manager.js"></script>
    <script>
        (() => {
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('slug');
            const titleEl = document.getElementById('post-title');
            const dateEl = document.getElementById('post-date');
            const contentEl = document.getElementById('post-content');
            const statusEl = document.getElementById('post-status');
            const backEl = document.getElementById('post-back');

            const showStatus = message => {
                statusEl.textContent = message;
                statusEl.style.display = 'block';
            };

            if (!slug) {
                showStatus('No post selected.');
                return;
            }

            fetch('blogentries/entries.json')
                .then(response => response.json())
                .then(data => {
                    const posts = Array.isArray(data.posts) ? data.posts : [];
                    const post = posts.find(p => p.slug === slug);

                    if (!post) {
                        showStatus('Post not found.');
                        return;
                    }

                    document.title = `${post.title} - ${post.displayDate || ''} | The Hybrid Habits`;
                    titleEl.textContent = post.title || 'Untitled';
                    const dateText = post.displayDate || post.sortDate || '';
                    const timeText = post.displayTime ? ` at ${post.displayTime}` : '';
                    dateEl.textContent = dateText + timeText;
                    contentEl.innerHTML = '';

                    // Support new 'content' format (text + images) or legacy 'paragraphs'
                    const contentItems = post.content || (post.paragraphs || []).map(text => ({type: 'text', value: text}));

                    contentItems.forEach(item => {
                        if (item.type === 'text') {
                            const paragraph = document.createElement('p');
                            paragraph.className = 'post-excerpt';
                            paragraph.textContent = item.value || item;
                            contentEl.appendChild(paragraph);
                        } else if (item.type === 'image') {
                            const figure = document.createElement('figure');
                            figure.className = 'blog-image';
                            
                            const img = document.createElement('img');
                            img.src = item.src || '';
                            img.alt = item.alt || '';
                            img.loading = 'lazy';
                            
                            figure.appendChild(img);
                            
                            if (item.caption) {
                                const caption = document.createElement('figcaption');
                                caption.textContent = item.caption;
                                figure.appendChild(caption);
                            }
                            
                            contentEl.appendChild(figure);
                        }
                    });

                    // Show comments section
                    document.getElementById('comments-section').style.display = 'block';

                    backEl.style.display = 'block';
                    statusEl.style.display = 'none';
                })
                .catch(() => {
                    showStatus('Could not load this post right now.');
                });
        })();
    </script>
</body>
</html>
